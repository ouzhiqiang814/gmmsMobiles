<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<meta name="copyright" content="www.apicloud.com" />
<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
<title>工作</title>
<link rel="stylesheet" type="text/css" href="../../css/api.css" />
<link rel="stylesheet" type="text/css" href="../../css/common.css" />
<style>
html,body {min-height: 100%; }

.topbar {background: #1081DA; height:50px; position: relative;}
.egret-header-title {position: absolute;width: 100%; line-height: 50px;color: #fff;font-size: 20px;text-align:center;}
.egret-img {position: absolute;}
.egret-img img {height: 30px;padding: 10px;vertical-align: top;}

/* card */
.sharecard {display: -webkit-box; -webkit-box-orient: vertical; border-radius: 5px; margin-left: 10px; margin-right: 10px; margin-top: 10px; padding: 10px 10px 15px 10px; border: 1px solid #e0e0e0;background-color: #fff;}
.sharecard .rightcol {-webkit-box-flex: 1;}
.sharecard .rightcol .usertitle {font-size: 0.9em; color: #666;}
.sharecard .rightcol .usertitle .username{font-size: 1em; color: #507DAF; margin-right: 5px;}
.sharecard .rightcol .usertitle .sharetime{float: right; font-size: 0.8em; color: #999;}
.sharecard .rightcol .sharecontent {font-size: 1em; line-height: 1.3em;padding-top: 5px;}

.sharecard .sharemusic{display: -webkit-box; margin-top: 8px; -webkit-box-align: center; }
.sharecard .sharemusic .musictitle { -webkit-box-flex: 1; padding-left:5px; border-left: 1px solid #e0e0e0;}
.sharecard .sharemusic .musictitle .title01{font-size: 0.7em;color: #999;}
.sharecard .sharemusic .musictitle .title01 img{width: 12px; height:12px; vertical-align: top;margin-right: 2px;}
.sharecard .sharemusic .musictitle .title02{font-size: 0.7em;color: #999;margin-top: 2px;}


/* 悬浮 */
.fmbtnhover {background: #D8D9DA ;}

.badge {
    font-size: 12px;
    line-height: 1;
    display: inline-block;
    padding: 6px 12px;
    color: #FFFFFF;
    border-radius: 100px;
}
.red {
    background-color: #dd524d;
}
.green {
    background-color: #99CC00;
}
</style>
</head>
<body id='headlist'>
<!-- 分享card -->
<!--<div class="sharecard" tapmode="fmbtnhover" onclick="openDynamic()">
	<div class="rightcol">
		<div class="usertitle">
			<span class="username">陈明</span>发送了一笔：<span class="sharetime">昨天17:23</span>
		</div>
		<p class="sharecontent">徐州东收费站UPS设备定期维护(2016年第2次 2016年02月01日-2016年02月29日)！</p>
	</div>
	
	<div class="sharemusic">
		<div class="musictitle" style='text-align: center;border:none;'>
			<span class="badge red">退回</span>
		</div>
		<div class="musictitle">
			<div class="title01"><img src='../../image/lkxc_save_sel.png'/>环节</div>
			<div class="title02">采购部经理审核</div>
		</div>
		<div class="musictitle">
			<div class="title01"><img src='../../image/newmine.png'/>创建人</div>
			<div class="title02">刘晨</div>
		</div>
		<div class="musictitle">
			<div class="title01"><img src='../../image/track_history_icon_sel.png'/>创建时间</div>
			<div class="title02">2016-01-09</div>
		</div>
	</div>
</div>

<div class="sharecard" tapmode="fmbtnhover" onclick="openDynamic()">
	<div class="rightcol">
		<div class="usertitle">
			<span class="username">陈明</span>发送了一笔：<span class="sharetime">昨天17:23</span>
		</div>
		<p class="sharecontent">徐州东收费站UPS设备定期维护</p>
	</div>
	
	<div class="sharemusic">
		<div class="musictitle" style='text-align: center;border:none;'>
			<span class="badge green">在办</span>
		</div>
		<div class="musictitle">
			<div class="title01"><img src='../../image/lkxc_save_sel.png'/>环节</div>
			<div class="title02">采购部经理审核</div>
		</div>
		<div class="musictitle">
			<div class="title01"><img src='../../image/newmine.png'/>创建人</div>
			<div class="title02">刘晨</div>
		</div>
		<div class="musictitle">
			<div class="title01"><img src='../../image/track_history_icon_sel.png'/>创建时间</div>
			<div class="title02">2016-01-09</div>
		</div>
	</div>
</div>-->
</body>
<script id="template" type="text/template">
	{{~ it:data }}
	<div class="sharecard" tapmode="fmbtnhover" onclick="openDynamic('{{=data.bsnum}}')">
		<div class="rightcol">
			<div class="usertitle">
				<span class="username">{{=data.prev_actor}}</span>发送了一笔：<span class="sharetime">{{=data.create_time}}</span>
			</div>
			<p class="sharecontent">{{=data.pname }}</p>
		</div>
		
		<div class="sharemusic">
			<div class="musictitle" style='text-align: center;border:none;'>
				{{? data.status == 0}}<span field="{{=data.bsnum}}" class="badge red">待处理</span>
				{{?? data.status == 1}}<span field="{{=data.bsnum}}" class="badge green">已处理</span>{{?}}
			</div>
			<div class="musictitle">
				<div class="title01"><img src='../../image/lkxc_save_sel.png'/>环节</div>
				<div class="title02">{{=data.current_node_name}}</div>
			</div>
			<div class="musictitle">
				<div class="title01"><img src='../../image/newmine.png'/>创建人</div>
				<div class="title02">{{=data.author_name}}</div>
			</div>
			<!--
			<div class="musictitle">
				<div class="title01"><img src='../../image/track_history_icon_sel.png'/>创建日期</div>
				<div class="title02">{{=data.start_time}}</div>
			</div> -->
		</div>
	</div>
	{{~}}
	<br/>
</script>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/zepto.min.js"></script>
<script type="text/javascript" src="../../script/doT.min.js"></script>
<script type="text/javascript" src="../../script/local.message.js"></script>
<script type="text/javascript" src="../../script/CDateTime.js"></script>
<script type="text/javascript">
	var headlist, dot, user;
	var isEmpty = false,
	isPull = true,
    skip = 0,
    limit = 10;
    var curBsnum = null;
	apiready = function (){
		fninit();
		fnInitDB();
		fnInitPull();
		fnInitPushRefresh();
		showBusinessTodo();
	}
	
	function fninit() {
    	user = $api.getStorage("user");
		headlist = $api.byId('headlist');
    	var template = $api.byId('template');
    	dot = doT.template(template.innerHTML);
    }
	
	// 刷新
    function fnInitPull() {
		api.setRefreshHeaderInfo({
		 	bgColor: '#efeff4',
	        dropColor:'#9BA2AC'
		},function(){
			skip = 0;
            isEmpty = false;
            isPull = true;
			showBusinessTodo();
		});
	};
	
	 // 下拉加载更多
	function fnInitPushRefresh() {
		api.addEventListener({
			name: 'scrolltobottom',
			extra: {
	      		threshold: 10
	    	}
	  	}, function(ret, err) {
	  		isPull = false;
	    	showBusinessTodo();
	  	});
	};
	
	function showBusinessTodo() {
		if (isEmpty) {
        	api.toast({
          		msg: '没有更多了',
          		duration: 2000,
          		location: 'bottom'
        	});
        	return;
      	}
		var moduleName = api.pageParam.name;
		var userId = user.id;
		var ret = fnFindBusinessTodoByModuleName(moduleName,userId,skip,limit);
    	if (ret.status) {
    		$.each(ret.data, function(idx,item){
    			item.create_time = tranTime(item.create_time);
    		});
    		
            if (isPull) {
	    		headlist.innerHTML = dot(ret.data);
            } else {
	    		headlist.innerHTML += dot(ret.data);
            }
            
    		skip += limit;
            if (ret.data.length < limit) {
              isEmpty = true;
            }
            //更新事务待办状态
            var bsnumStr = "";
            $.each(ret.data,function(i,item){
            	bsnumStr += ","+item.bsnum;
            });
            if(bsnumStr!=""){
            	bsnumStr = bsnumStr.substring(1);
	            api.ajax({
		            url:$api.getStorage("gmms_url")+'modules/mobile/business/business-deal!queryStatusByBsnum.action',            
		            timeout:10,
		            method:'post',
		            data:{
		            	values:{userId:$api.getStorage("userId"),bsnumStr:bsnumStr}
		            },
		            dataType:'text'
	            },function(ret,err){
	            	if(ret){
	            		var bsnums = ret.split(',');
	            		$.each(bsnums,function(i,bsnum){
	            			fnSetBusinessTodoForHandle(bsnum);//更新已处理状态
				    		$("span[field='"+bsnum+"']").attr('class','badge green');
							$("span[field='"+bsnum+"']").html('已处理');
	            		});	            		
	            	}
	            	api.refreshHeaderLoadDone(); //刷新结束
	            });
    		}else{
    			api.refreshHeaderLoadDone(); //刷新结束
    		}
	    } else 
	        alert(ret.msg);
    }
    
    
    function setBadgeForNone(moduleName){
    	var jsfun = 'setBadgeForNone("' + moduleName + '")';
		api.execScript({
		    name: 'main',//窗口名
		    frameName : 'first_frame',
		    script: jsfun
		});
    }
    
    function openDynamic(bsnum){
    	curBsnum = bsnum;
		api.openWin({
			name: '事务处理',
			url: './business_deal_todo.html',
			pageParam: {
		        bsnum: curBsnum
		    }
		});       
    }
    //服务端处理完成回调方法
    function serverBackHandle(backmsg){
   		if((backmsg=='success'||backmsg=='exist') && curBsnum!=null){
    		fnSetBusinessTodoForHandle(curBsnum);//更新已处理状态
    		$("span[field='"+curBsnum+"']").attr('class','badge green');
			$("span[field='"+curBsnum+"']").html('已处理');
    	}
    }
</script>
</html>